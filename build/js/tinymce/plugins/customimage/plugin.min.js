function stateChange(event) {
    if (event.target.readyState == 4) {
        console.log(event);
    }
}


tinymce.PluginManager.add('customimage', function (editor, url) {

    function showDialog() {
        var file = url + '/dialog/dialog.html';
        var frame = editor.windowManager.open({
            title: 'Добавить изображение',
            body: {
                type: 'panel',
                items: [{
                    type: 'dropzone',
                    name: 'files'
                }]
            },
            buttons: [
                {
                    type: 'cancel',
                    name: 'close',
                    text: 'Close'
                }
            ],
            onAction: function (dialogApi, actionData) {

            },
            onChange: function (dialogApi, changeData) {
                var data = dialogApi.getData();
                if (changeData.name === 'files') {
                    const formData = new FormData();

                    data.files.forEach((file, i) => {
                        formData.append(i, file)
                    });

                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function (ev) {
                        if (event.target.readyState == 4) {
                            const res = JSON.parse(ev.target.responseText);
                            const imageLayout = '<img src="' + res[0].url + '"/>';
                            dialogApi.redial({
                                title: 'Добавить изображение',
                                body: {
                                    type: 'panel',
                                    items: [{
                                        type: 'htmlpanel',
                                        html: imageLayout
                                    }]
                                },
                                buttons: [
                                    {
                                        type: 'cancel',
                                        name: 'close',
                                        text: 'Close'
                                    },
                                    {
                                        type: 'custom',
                                        name: 'submit',
                                        text: 'Вставить',
                                    }
                                ],
                                onAction: function (dialogApi, actionData) {
                                    tinymce.activeEditor.execCommand('mceInsertContent', false, imageLayout);
                                    dialogApi.close();
                                }
                            })
                        }
                    };
                    xhr.open('POST', '/api/image-upload');
                    xhr.send(formData);
                }
            }
        });
    }


    // Add a button that opens a window
    editor.ui.registry.addButton('customimage', {
        text: '',
        icon: 'image',
        tooltip: 'Добавить изображение',
        onAction: showDialog
    });
});